# Многоуровневая организация программных систем
## Отчёт по курсовой работе
**Тема:** Разработка простого IoT-сервиса.  
**Выполнил:** Попов П.С.  
**Группа:** P4116  
**Преподаватель:** Перл И.А.  
**Дата:** 28.11.2024


### Архитектура системы
Требуется разработать IoT-сервис согласно данной архитектуре.
![Архитектура системы](architecture.png)  
Сервис должен содержать части:
1. `Data Simulator` - сервис, эмулирующий поток данных, которые циркулируют по системе.
2. `IoT Controller` - сервис, выполняющий фильтрацию, валидацию входных данных и определяющий их дальнейшую траекторию передвижения.
3. `Rule Engine` - сервис, обрабатывающий данные от `IoT controller`. По заранее установленных правилам выполняет вставку записей в базу данных`MongoDB`.
4. `MongoDb` - хранилище данных.
5. `Compass` - визуализация данных, содержащихся в БД.
6. `Rabbitmq` - брокер сообщений для передачи данных из `IoT Controller` в `Rule Engine`.
7. `Prometheus` - компонент, используемый для сбора метрик разрабватываемого решения.
8. `Grafana` - визуализация данных, собранных `Prometheus`. 
9. `ELK stack`. Комплекс сервисов для сборки логов.

### Установленный формат данных
В качестве единицы данных используется `Protobuf` сообщение `Batch`.
```proto
message Batch {
    int32 device_id = 1;
    float alpha = 2;
    float beta = 3;
    string timestamp = 4;
}
```
`Batch` содержит информацию:
- `id` отправителя (устройство, с которого пришли данные)
- `alpha`,`beta` - безымянные поля с "некоторой информацией", обрабатываемой IoT-системой.
- `timestamp` - временная метка сообщения.
### Бизнес-логика разрабатываемого решения
1. `Data Simulator` генерирунет данные.    Поддерживаются настройки:  
    -  Количество клиентов
    - Частота отправки [сообщений\секунду].
2. `IoT Controller`. Осуществляет валидацию пакетов по следующему алгоритму принятия решений: 
 - Если поле `alpha` входящего пакета  < 25, то `IoT Controller` не принимает пакет.
 3. `Rule Engine`. Выполняет data-processing и заполняет БД событиями `instant rule, ongoing rule`. Ведёт учёт последних `k=10` пакетов при помощи БД. 
  - Если поле `alpha` < 50, то срабатывает `instant rule` и выполняется запсь в БД с временной меткой этого события.
  - Для каждого из подключённых клиентов создаётся "микро стек" в БД размер которого всегда не превышает 10 сообщений.  
  Каждое новое сообщение попадает в этот стек.  
  Отслеживается следующее: если поле `beta` >= 75 встречается более 5 раз на протяжении 10 пакетов для данного `device id`, то срабатывает ongoing rule, и запись с уведомлением помещается в БД. 
### Организация взаимодействия модулей
1. Каждое решение помещается в свой собственный контейнер.
2. Взаимодействие происходит при помощи `docker`-сети.
### Программное обеспечение
Помимо ранее объявленного ПО, укажем следующее:
1. `docker, docker-compose` - контейнеризация разрабатываемых решений.
2. `python, fastAPI` - основной язык программирования  
`poetry` - пакетный менеджер `Python`.
3. `Google Protobuf 3` - сериализация\десериализация сообщений. 

### Перечень собираемых приложением метрик 
1. `Controller`: количество принятых/не принятых пакетов.
2. `Rule Engine`: количество сработавших `instant, ongoing rules`. 
3. `Datasim`: количество подключенных устройств в момент времени `t`.
4. `Datasim`: количество успешно принятых запросов
5. `Datasim`: количество устройств.
6. `Datasim`: длительность обработки одного запроса.
5. `Rabbitmq`: количество сообщений, прошедших через брокер.
